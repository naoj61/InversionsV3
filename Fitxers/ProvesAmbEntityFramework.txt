using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Data.Entity.Validation;
using System.Linq;
using System.Windows.Forms;
using System.Windows.Forms.VisualStyles;

namespace Inversions
{
    public partial class Form1 : Form
    {

        public Form1()
        {
            InitializeComponent();

            using (var ctx = new MyClass())
            {
                Mercat m = new Mercat() {Nom = "M1"};
                ctx.Mercats.Add(m);
                ctx.SaveChanges();

                m = new Mercat() { Nom = "M1" };
                ctx.Mercats.Add(m);
                ctx.SaveChanges();
            }

            using (var ctx = new MyClass())
            {
                Moviment e1 = new Moviment();
                ctx.Moviments.Add(e1);
                ctx.SaveChanges();

                Moviment e2 = new Moviment();
                ctx.Moviments.Add(e2);
                ctx.SaveChanges();

                e1.Traspas1 = e2;
                ctx.SaveChanges();
            }


            Empresa emp = new Empresa { Nom = "Emp6" };

            emp = InsereixEmpresa(emp);

            //// Llegeix la stored procedure: GetGestorsByEmpresaId
            //using (var context = new InversionsBDContainer())
            //{
            //    foreach (GetGestorsByEmpresaId_Result cs in context.GetGestorsByEmpresaId(1))
            //    {
            //        Console.WriteLine(cs.NomEmpresa);
            //        Console.WriteLine(cs.NomGestor);
            //    }
            //}

            //ExempleErrorConcurrencia();


            //InsereixEmpresa("");
            //InsereixEmpresa("ddd4rex");


            //InsereixEmpresa("ddd4rex");
            //InsereixGestor("Gestor1", MyClass.Sessio.Empreses.Single(f => f.Nom == "ddd4rex"));

            // *** Insereix l'empresa i el gestor simultaniament ***

            //Empresa emp = new Empresa {Nom = "Emp3.1"};
            //MyClass.Sessio.Empreses.Add(emp);

            //InsereixEmpresa("dddff");

            //ModificaEmpresa("dddaa", "dddff");
            //InsereixEmpresa("ddd4rex");
            //InsereixEmpresa("ddd4rex");
            //ModificaEmpresa(3, "dddff35g");


            var entries = MyClass.Sessio.ChangeTracker.Entries();
            foreach (var entry in entries)
            {
                Console.WriteLine("Entity Name: {0}", entry.Entity.GetType().FullName);
                Console.WriteLine("Status: {0}", entry.State);
            }
        }

        private static void ExempleErrorConcurrencia()
        {

            Empresa empresa1WithUser1 = null;
            Empresa empresa1WithUser2 = null;

            //User 1 gets student
            using (var context = new InversionsBDContainer())
            {
                context.Configuration.ProxyCreationEnabled = false;
                empresa1WithUser1 = context.Empreses.Single(s => s.Id == 1);
            }
            //User 2 also get the same student
            using (var context = new InversionsBDContainer())
            {
                context.Configuration.ProxyCreationEnabled = false;
                empresa1WithUser2 = context.Empreses.Single(s => s.Id == 1);
            }
            //User 1 updates Student name
            empresa1WithUser1.Nom = "Edited from user1";
            //User 2 updates Student name
            empresa1WithUser2.Nom = "Edited from user2";

            //User 1 saves changes first
            using (var context = new InversionsBDContainer())
            {
                try
                {
                    context.Entry(empresa1WithUser1).State = EntityState.Modified;
                    context.SaveChanges();
                }
                catch (DbUpdateConcurrencyException)
                {
                    Console.WriteLine("Optimistic Concurrency exception occured");
                }
            }

            //User 2 saves changes after User 1. 
            //User 2 will get concurrency exection 
            //because CreateOrModifiedDate is different in the database 
            using (var context = new InversionsBDContainer())
            {
                try
                {
                    context.Entry(empresa1WithUser2).State = EntityState.Modified;
                    context.SaveChanges();
                }
                catch (DbUpdateConcurrencyException ex)
                {
                    var entry = ex.Entries.Single();
                    var currentValues = entry.CurrentValues.GetValue<String>("Nom");
                    var databaseValues = entry.GetDatabaseValues().GetValue<String>("Nom"); 
 
                    Console.WriteLine("Optimistic Concurrency exception occured");
                }
            }
        }


        private static Gestor InsereixGestor(MyClass sessio, string nom, Empresa empresa)
        {
            try
            {
                Empresa empresaExistent = null;
                if (MyClass.Sessio.Entry(empresa).State == EntityState.Detached)
                    empresaExistent = MyClass.Sessio.Empreses.FirstOrDefault(f => f.Nom == empresa.Nom);

                Gestor gestor = new Gestor { Nom = nom, Empresa = empresaExistent ?? empresa};

                var ee = MyClass.Sessio.Gestors.Add(gestor);

                if (ee != null)
                    MyClass.Sessio.SaveChanges();

                return ee;
            }
            catch (DbEntityValidationException ex1)
            {
                foreach (var err2 in ex1.EntityValidationErrors.SelectMany(err => err.ValidationErrors))
                {
                    System.Diagnostics.Debug.WriteLine(err2.PropertyName);
                    System.Diagnostics.Debug.WriteLine(err2.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex);
            }
            return null;
        }

        private static void ModificaGestor(Gestor gestor, string nomNou)
        {
            try
            {
                if (gestor != null)
                {
                    gestor.Nom = nomNou;
                    MyClass.Sessio.SaveChanges();
                }
            }
            catch (DbEntityValidationException ex1)
            {
                MyClass.Sessio.Empreses.Local.Clear();
                foreach (var err2 in ex1.EntityValidationErrors.SelectMany(err => err.ValidationErrors))
                {
                    System.Diagnostics.Debug.WriteLine(err2.PropertyName);
                    System.Diagnostics.Debug.WriteLine(err2.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex);
            }
        }


        private static void ModificaEmpresa(Empresa empresa, string nomNou)
        {
            try
            {
                if (empresa != null)
                {
                    empresa.Nom = nomNou;
                    MyClass.Sessio.SaveChanges();
                }
            }
            catch (DbEntityValidationException ex1)
            {
                MyClass.Sessio.Empreses.Local.Clear();
                foreach (var err2 in ex1.EntityValidationErrors.SelectMany(err => err.ValidationErrors))
                {
                    System.Diagnostics.Debug.WriteLine(err2.PropertyName);
                    System.Diagnostics.Debug.WriteLine(err2.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex);
            }
        }

        private static void ModificaEmpresa(int id, string nomNou)
        {
            ModificaEmpresa(MyClass.Sessio.Empreses.Find(id), nomNou);
        }

        private static void ModificaEmpresa(string nomOrig, string nomNou)
        {
            ModificaEmpresa(MyClass.Sessio.Empreses.SingleOrDefault(f => f.Nom == nomOrig), nomNou);
        }

        private static void EsborraEmpresa(Empresa empresa)
        {
            try
            {
                if (empresa != null)
                {
                    MyClass.Sessio.Empreses.Remove(empresa);
                    MyClass.Sessio.SaveChanges();
                }
            }
            catch (DbEntityValidationException ex1)
            {
                foreach (var err2 in ex1.EntityValidationErrors.SelectMany(err => err.ValidationErrors))
                {
                    System.Diagnostics.Debug.WriteLine(err2.PropertyName);
                    System.Diagnostics.Debug.WriteLine(err2.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex);
            }
        }
    
        private static void EsborraEmpresa(string nom)
        {
            EsborraEmpresa(MyClass.Sessio.Empreses.SingleOrDefault(f => f.Nom == nom));
        }

        private static Empresa InsereixEmpresa(string nom)
        {
            return InsereixEmpresa(new Empresa {Nom = nom});
        }

        private static Empresa InsereixEmpresa(Empresa empresa)
        {
            try
            {
                var ee = MyClass.Sessio.Empreses.Add(empresa);

                if (ee != null)
                    MyClass.Sessio.SaveChanges();

                // var newStudentEntity = dbcontext.Empreses.Create();

                //var studentEntry = MyClass.DbContext.Entry(e);
                //System.Diagnostics.Debug.WriteLine(studentEntry);

                return ee;
            }
            catch (DbEntityValidationException ex1)
            {
                MyClass.Sessio.Empreses.Local.Clear();

                foreach (var err2 in ex1.EntityValidationErrors.SelectMany(err => err.ValidationErrors))
                {
                    System.Diagnostics.Debug.WriteLine(err2.PropertyName);
                    System.Diagnostics.Debug.WriteLine(err2.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex);
            }
            return null;
        }
    }
}
